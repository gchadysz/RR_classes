---
title: "Yahoo Finance stock price analysis"
subtitle: "`r params$Company`"
author: "Grzegorz Chadysz, Konrad Archici≈Ñski"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output:
  rmdformats::readthedown:
    self_contained: true
params:
  Company:
    value: "Apple Inc."
    input: select
    choices: ["Apple Inc.",
              "Intel Corporation",
              "Microsoft Corporation",
              "NVIDIA Corporation",
              "Advanced Micro Devices, Inc.",
              "General Motors Company",
              "Ford Motor Company",
              "Toyota Motor Corporation"]
  From: 
    value: !r lubridate::today() - 1000
    input: date
    max: !r lubridate::today()
  To:
    value: !r lubridate::today()
    input: date
    max: !r lubridate::today()
  Columns: 
    value: "None"
    label: "Which quotes should be included? (remove with DEL)"
    choices: ["Open", "High", "Low", "Close", "Volume", "Adjusted"]
    input: select
    multiple: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=F, message=F, warning=F}
library(quantmod)
library(tidyverse)
library(data.table)
library(kableExtra)
library(hrbrthemes)
library(plotly)
library(urca)

invisible(Sys.setlocale("LC_TIME", "English"))
```

***

# Introduction 

```{r, echo=F}
# "Dictionary" of companies and their stock abbreviations
dict <- list("AAPL", "INTC", "MSFT", "NVDA", "AMD", "GM", "F", "TM")

names(dict) <- c(
  "Apple Inc.",
  "Intel Corporation",
  "Microsoft Corporation",
  "NVIDIA Corporation",
  "Advanced Micro Devices, Inc.",
  "General Motors Company",
  "Ford Motor Company",
  "Toyota Motor Corporation"
)
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

***

# Data

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

```{r, echo=F, message=F, warning=F}
# Getting quotes
quotes <- getSymbols(
  dict[[params$Company]],
  auto.assign = F,
  from = params$From,
  to = params$To
)
```

```{r, echo=F, warning=F}
columns_all <-
  c("Open", "High", "Low", "Close", "Volume", "Adjusted")

# If no columns were selected then all are selected by default
if (params$Columns == "None") {
  columns_to_keep <- paste0(dict[[params$Company]], ".", columns_all)
} else {
  columns_to_keep <- paste0(dict[[params$Company]], ".", params$Columns)
}

# Subsetting selected columns
quotes <- subset(quotes, select = columns_to_keep)

# Changing to data frame format
quotes <- data.frame(Date = index(quotes), coredata(quotes))

kable(head(quotes), row.names = F, caption = "Oldest observations") %>%
  kable_styling(bootstrap_options = c("hover"))

kable(tail(quotes), row.names = F, caption = "Most recent observations") %>%
  kable_styling(bootstrap_options = c("hover"))
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

***

# Plots

```{r, echo=F, warning=F, message=F}
# Melting the data into long format in order to plot more efficiently
quotes_long <- melt(quotes, id = "Date")
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

***

## Plotly interactive graph

```{r, echo=F, out.width="100%", warning=F}
# "not like" function
`%notlike%` <- Negate(`%like%`)

# Plot stock prices (no volume)
p <-
  ggplot(quotes_long[quotes_long$variable %notlike% "Volume", ], aes(x = Date)) +
  geom_line(aes(y = value, color = variable)) +
  theme_modern_rc() +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 6)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(
    title = paste(params$Company, "stock prices"),
    x = NULL,
    y = NULL
  )

ggplotly(p, dynamicTicks = TRUE)
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."

```{r, echo=F, out.width="100%"}
# Plot volume if it was chosen

if(any(quotes_long$variable %like% "Volume")) {
  p <-
    ggplot(quotes_long[quotes_long$variable %like% "Volume",], aes(x = Date)) +
    geom_line(aes(y = value)) +
    theme_modern_rc() +
    scale_y_continuous(breaks = scales::pretty_breaks(n = 6),
                       labels = scales::comma) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(
      title = paste(params$Company, "stock volume"),
      x = NULL,
      y = NULL
    )
  ggplotly(p, dynamicTicks = TRUE)
}
```

***

```{r, echo=F}
gg_list <- list()

for (i in 1:(ncol(quotes) - 1)) {
  gg_list[[i]] <-
    ggplot(quotes, aes_string(x = colnames(quotes)[1])) +
      geom_line(aes_string(y = colnames(quotes)[i + 1])) +
      theme_modern_rc() +
      scale_x_date(date_labels = "%m/%Y") +
      scale_y_continuous(breaks = scales::pretty_breaks(n = 5)) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
      labs(y = "Value")
}
```

## Each on separate tab {.tabset}

```{r, results="asis", echo=FALSE}
for (i in 1:length(gg_list)) {
  cat("###", colnames(quotes)[i+1], " \n")
  print(gg_list[[i]]) # ggplotly does not work
  cat(" \n \n")
}
```

# Descriptive statistics

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

# Stationarity analysis {.tabset .tabset-fade}

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

## Trend

```{r, echo=F, eval=T, out.width="100%"}
# First column is to be tested for stationarity
series_to_test <- xts(x = quotes[[2]], order.by = quotes[[1]])

# First test
test <- ur.df(series_to_test, type = "trend")
test_statistic <- test@teststat[1]
critical_value <- test@cval[1, 2]
i = 0

# If not stationary, then check differences until stationary
while(test_statistic >= critical_value){
  series_to_test <- diff.xts(series_to_test, na.pad = F)
  test <- ur.df(series_to_test, type = "trend")
  test_statistic <- test@teststat[1] 
  critical_value <- test@cval[1, 2]
  i = i + 1   # counter for differentiating order
}

# ADF test summary
summary(test)

# Stationary plot
p <- ggplot(series_to_test, aes(x = index(series_to_test), y = coredata(series_to_test))) +
  geom_line() +
  theme_modern_rc() +
  labs(x = "Date", y = "Value") +
  scale_x_date(date_labels = "%m/%Y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = NULL)

ggplotly(p)
```

According to the ADF test the series are integrated of order `r i`, or in other words have become stationary after `r i` differentiation(s).

***

## Drift

```{r, echo=F, eval=T, out.width="100%"}
# First column is to be tested for stationarity
series_to_test <- xts(x = quotes[[2]], order.by = quotes[[1]])

# First test
test <- ur.df(series_to_test, type = "drift")
test_statistic <- test@teststat[1]
critical_value <- test@cval[1, 2]
i = 0

# If not stationary, then check differences until stationary
while(test_statistic >= critical_value){
  series_to_test <- diff.xts(series_to_test, na.pad = F)
  test <- ur.df(series_to_test, type = "drift")
  test_statistic <- test@teststat[1] 
  critical_value <- test@cval[1, 2]
  i = i + 1   # counter for differentiating order
}

# ADF test summary
summary(test)

# Stationary plot
p <- ggplot(series_to_test, aes(x = index(series_to_test), y = coredata(series_to_test))) +
  geom_line() +
  theme_modern_rc() +
  labs(x = "Date", y = "Value") +
  scale_x_date(date_labels = "%m/%Y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(p)
```

According to the ADF test the series are integrated of order `r i`, or in other words have become stationary after `r i` differentiation(s).

***

## None

```{r, echo=F, eval=T, out.width="100%"}
# First column is to be tested for stationarity
series_to_test <- xts(x = quotes[[2]], order.by = quotes[[1]])

# First test
test <- ur.df(series_to_test, type = "none")
test_statistic <- test@teststat[1]
critical_value <- test@cval[1, 2]
i = 0

# If not stationary, then check differences until stationary
while(test_statistic >= critical_value){
  series_to_test <- diff.xts(series_to_test, na.pad = F)
  test <- ur.df(series_to_test, type = "none")
  test_statistic <- test@teststat[1] 
  critical_value <- test@cval[1, 2]
  i = i + 1   # counter for differentiating order
}

# ADF test summary
summary(test)

# Stationary plot
p <- ggplot(series_to_test, aes(x = index(series_to_test), y = coredata(series_to_test))) +
  geom_line() +
  theme_modern_rc() +
  labs(x = "Date", y = "Value") +
  scale_x_date(date_labels = "%m/%Y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(p)
```

According to the ADF test the series are integrated of order `r i`, or in other words have become stationary after `r i` differentiation(s).

***

# Forecasting

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.